{% extends 'base.html' %}
{% load static %}

{% block title %}My Preferences - DriveMe Home{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/3.1.2/mapbox-gl.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 mt-20 max-w-4xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-8">My Preferences</h1>

    <!-- MESSAGES BLOCK -->
    {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="p-4 text-sm rounded-lg flex items-center
            {% if message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200
            {% elif message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200
            {% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}" role="alert">
            <svg class="shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
            </svg>
            <div>{{ message }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="grid md:grid-cols-2 gap-8">
        
        <!-- 1. Saved Destinations -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Saved Places
                </h2>
                <!-- Button to open "Add" Modal -->
                <button type="button" onclick="openDestModal()" class="text-sm text-blue-600 hover:underline font-semibold">
                    + Add New
                </button>
            </div>
            
            <div class="space-y-3">
                {% for dest in destinations %}
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg group">
                    <div>
                        <p class="font-semibold text-gray-800">{{ dest.name }}</p>
                        <p class="text-xs text-gray-500 truncate w-48">{{ dest.address }}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Edit Button -->
                        <!-- Pass the FULL URL for editing -->
                        <button type="button" 
                            onclick="openDestModal('{{ dest.id }}', '{{ dest.name|escapejs }}', '{{ dest.address|escapejs }}', '{{ dest.latitude }}', '{{ dest.longitude }}', '{% url 'edit_destination' dest.id %}')" 
                            class="text-gray-400 hover:text-blue-600 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <!-- Delete Button -->
                        <form action="{% url 'delete_destination' dest.id %}" method="POST" onsubmit="return confirm('Are you sure?');">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-red-500 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm text-center py-4">No saved places yet.</p>
                {% endfor %}
            </div>
        </div>

        <!-- 2. Emergency Contacts -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-700 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    Emergency Contacts
                </h2>
                <button type="button" onclick="openContactModal()" class="text-sm text-blue-600 hover:underline font-semibold">
                    + Add New
                </button>
            </div>

            <div class="space-y-3">
                {% for contact in contacts %}
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg group">
                    <div>
                        <p class="font-semibold text-gray-800">{{ contact.name }} <span class="text-xs font-normal text-gray-500">({{ contact.relationship }})</span></p>
                        <p class="text-xs text-gray-500">{{ contact.phone_number }}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Edit Button -->
                        <button type="button" 
                            onclick="openContactModal('{{ contact.id }}', '{{ contact.name|escapejs }}', '{{ contact.phone_number|escapejs }}', '{{ contact.relationship|escapejs }}', '{% url 'edit_contact' contact.id %}')"
                            class="text-gray-400 hover:text-blue-600 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <!-- Delete Button -->
                        <form action="{% url 'delete_contact' contact.id %}" method="POST" onsubmit="return confirm('Remove this contact?');">
                            {% csrf_token %}
                            <button type="submit" class="text-gray-400 hover:text-red-500 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm text-center py-4">No contacts added.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Destination Modal (Shared for Add/Edit) -->
<div id="dest-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full bg-gray-900/50 backdrop-blur-sm justify-center items-center">
    <div class="relative w-full max-w-lg max-h-full m-auto">
        <div class="relative bg-white rounded-lg shadow-2xl">
            <button type="button" onclick="closeDestModal()" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
            </button>
            
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900" id="dest-modal-title">Add Saved Place</h3>
                
                <form id="dest-form" method="POST" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Label (e.g. Home)</label>
                        {{ dest_form.name }}
                    </div>
                    
                    <!-- Map Container -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-900">Location</label>
                        <div id="modal-map" class="w-full h-48 rounded-lg bg-gray-100 relative"></div>
                        <button type="button" id="btn-modal-current-loc" class="text-xs text-blue-600 font-semibold hover:underline flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Use Current Location
                        </button>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Address</label>
                        {{ dest_form.address }}
                        <!-- Explicit IDs for targeting via JS -->
                        {{ dest_form.latitude }}
                        {{ dest_form.longitude }}
                    </div>
                    <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Save Place</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal (Shared for Add/Edit) -->
<div id="contact-modal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full bg-gray-900/50 backdrop-blur-sm justify-center items-center">
    <div class="relative w-full max-w-md max-h-full m-auto">
        <div class="relative bg-white rounded-lg shadow-2xl">
            <button type="button" onclick="closeContactModal()" class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
            </button>
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900" id="contact-modal-title">Add Contact</h3>
                <form id="contact-form" method="POST" class="space-y-4">
                    {% csrf_token %}
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Name</label>
                        {{ contact_form.name }}
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Phone</label>
                        {{ contact_form.phone_number }}
                    </div>
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-900">Relationship</label>
                        {{ contact_form.relationship }}
                    </div>
                    <button type="submit" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Save Contact</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-gl/3.1.2/mapbox-gl.js" xintegrity="sha512-CXG5vBw2QN9i5lXmqX2+F4XN844F4194464+26353134" crossorigin="anonymous" onerror="console.error('Mapbox failed')"></script>
<script>
    // --- MAPBOX SETUP ---
    // Ensure mapbox_access_token is passed in the view context
    const MAPBOX_TOKEN = "{{ mapbox_access_token }}";
    
    if (MAPBOX_TOKEN) {
        mapboxgl.accessToken = MAPBOX_TOKEN;
    }

    let map = null;
    let marker = null;

    function initModalMap(lat=null, lng=null) {
        if (!MAPBOX_TOKEN) return; // Skip if no token

        if (!map) {
            map = new mapboxgl.Map({
                container: 'modal-map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [30.0619, -1.9441], // Kigali default
                zoom: 12
            });
            
            // Map Click -> Move Pin
            map.on('click', (e) => {
                setPin(e.lngLat.lng, e.lngLat.lat);
            });
        }
        
        // Handle resize when modal shows
        setTimeout(() => map.resize(), 200);

        if (lat && lng) {
            setPin(lng, lat);
            map.flyTo({ center: [lng, lat], zoom: 14 });
        }
    }

    function setPin(lng, lat) {
        if (!marker) {
            marker = new mapboxgl.Marker({ draggable: true, color: '#3b82f6' })
                .setLngLat([lng, lat])
                .addTo(map);
            
            marker.on('dragend', () => {
                const pos = marker.getLngLat();
                updateInputs(pos.lng, pos.lat);
            });
        } else {
            marker.setLngLat([lng, lat]);
        }
        updateInputs(lng, lat);
    }

    function updateInputs(lng, lat) {
        // Specifically target the inputs within the destination form to avoid ambiguity
        const form = document.getElementById('dest-form');
        const latInput = form.querySelector('[name="latitude"]');
        const lngInput = form.querySelector('[name="longitude"]');
        
        if (latInput && lngInput) {
            // Fix: Round coordinates to 6 decimal places to fit Django DecimalField(max_digits=9, decimal_places=6)
            latInput.value = parseFloat(lat).toFixed(6);
            lngInput.value = parseFloat(lng).toFixed(6);
        }
    }

    // --- MODAL LOGIC (DESTINATION) ---
    const destModal = document.getElementById('dest-modal');
    const destForm = document.getElementById('dest-form');
    const destTitle = document.getElementById('dest-modal-title');
    const addDestUrl = "{% url 'add_destination' %}";

    function openDestModal(id=null, name='', address='', lat=null, lng=null, editUrl='') {
        destModal.classList.remove('hidden');
        destModal.classList.add('flex');
        
        if (id) {
            // Edit Mode
            destTitle.textContent = "Edit Saved Place";
            destForm.action = editUrl; // Use the URL passed from Django
            
            // Populate fields
            destForm.querySelector('[name="name"]').value = name;
            destForm.querySelector('[name="address"]').value = address;
            destForm.querySelector('[name="latitude"]').value = lat;
            destForm.querySelector('[name="longitude"]').value = lng;
            
            if (lat && lng) {
                initModalMap(parseFloat(lat), parseFloat(lng));
            } else {
                initModalMap();
            }
        } else {
            // Add Mode
            destTitle.textContent = "Add Saved Place";
            destForm.action = addDestUrl;
            destForm.reset();
            initModalMap();
        }
    }

    function closeDestModal() {
        destModal.classList.add('hidden');
        destModal.classList.remove('flex');
    }

    // Current Location Button
    document.getElementById('btn-modal-current-loc').addEventListener('click', () => {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                setPin(pos.coords.longitude, pos.coords.latitude);
                map.flyTo({ center: [pos.coords.longitude, pos.coords.latitude], zoom: 14 });
            });
        } else {
            alert("Geolocation is not supported by your browser.");
        }
    });

    // --- MODAL LOGIC (CONTACT) ---
    const contactModal = document.getElementById('contact-modal');
    const contactForm = document.getElementById('contact-form');
    const contactTitle = document.getElementById('contact-modal-title');
    const addContactUrl = "{% url 'add_contact' %}";

    function openContactModal(id=null, name='', phone='', rel='', editUrl='') {
        contactModal.classList.remove('hidden');
        contactModal.classList.add('flex');
        
        if(id) {
            contactTitle.textContent = "Edit Contact";
            contactForm.action = editUrl; // Use the URL passed from Django
            
            // Populate fields
            contactForm.querySelector('[name="name"]').value = name;
            contactForm.querySelector('[name="phone_number"]').value = phone;
            contactForm.querySelector('[name="relationship"]').value = rel;
        } else {
            contactTitle.textContent = "Add Contact";
            contactForm.action = addContactUrl;
            contactForm.reset();
        }
    }

    function closeContactModal() {
        contactModal.classList.add('hidden');
        contactModal.classList.remove('flex');
    }
</script>
{% endblock %}