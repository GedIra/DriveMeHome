{% extends "users/authentication/base.html" %}

{% block title %}
  {% if validlink %}Set New Password{% else %}Link Expired{% endif %} - DriveMe Home
{% endblock %}

{% block header_title %}
  {% if validlink %}New Password{% else %}Link Expired{% endif %}
{% endblock %}

{% block header_subtitle %}
  {% if validlink %}Choose a strong password{% else %}Please request a new reset link{% endif %}
{% endblock %}

{% block content %}
  {% if validlink %}
    <form method="POST" class="space-y-4">
      {% csrf_token %}
      
      {% if form.non_field_errors %}
        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
          {% for error in form.non_field_errors %}
            <p class="text-sm text-red-700">{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% for field in form %}
        <div class="relative group">
          <label class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
          
          <div class="relative">
            {{ field }}
            <!-- Eye Icon Toggle -->
            <button type="button" onclick="togglePasswordVisibility('{{ field.auto_id }}', this)" 
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-blue-600 cursor-pointer focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>

          {% if field.help_text %}
            <p class="text-xs text-gray-500 mt-1 leading-relaxed">{{ field.help_text|safe }}</p>
          {% endif %}
          
          {% if field.errors %}
            {% for error in field.errors %}
              <p class="text-xs text-red-500 mt-1 font-medium">{{ error }}</p>
            {% endfor %}
          {% endif %}
        </div>
      {% endfor %}

      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition mt-6">
        Change Password
      </button>
    </form>

    <script>
      function togglePasswordVisibility(fieldId, btn) {
        const input = document.getElementById(fieldId);
        const svg = btn.querySelector('svg');
        
        if (input.type === 'password') {
          input.type = 'text';
          // Eye Off Icon
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7a10.05 10.05 0 011.574-2.59M7 7l-1.5-1.5m13 13l1.5 1.5m-3.5-3.5l-1.5-1.5" />';
          btn.classList.add('text-blue-600');
        } else {
          input.type = 'password';
          // Eye Icon
          svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
          btn.classList.remove('text-blue-600');
        }
      }
    </script>

  {% else %}
    <div class="text-center py-4">
      <div class="text-red-500 text-5xl mb-4">⚠️</div>
      <p class="text-gray-700 mb-6">
        The password reset link is invalid or has expired.
      </p>
      <a href="{% url 'users:password_reset' %}" class="inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
        Request New Link
      </a>
    </div>
  {% endif %}
{% endblock %}